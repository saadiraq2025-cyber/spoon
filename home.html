<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>دفتر الديون</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

<h2>إضافة دين جديد</h2>

<input id="dName" placeholder="الاسم">
<select id="dType">
    <option value="مدين">مدين</option>
    <option value="مدان">مدان</option>
</select>
<input id="dAmount" type="number" placeholder="المبلغ">

<button onclick="addDebt()">إضافة الدين</button>

<hr style="margin:20px 0;">

<h2>البحث عن مدين / مدان</h2>

<input id="searchName" placeholder="ابحث بالاسم" oninput="render()">

<div id="resultsBox" style="margin-top:20px;"></div>

<div class="totalBox">المجموع الكلي: <span id="total">0</span> دينار</div>

<button onclick="logout()" style="background:red;margin-top:15px;">خروج</button>

</div>

<script>
let loginUser = JSON.parse(localStorage.getItem("loginUser"));
if(!loginUser) window.location.href="index.html";

// رقم المستخدم
let userPhone = loginUser.phone;

// جميع الديون من التخزين
let allDebts = JSON.parse(localStorage.getItem("debts") || "{}");

// اول دخول
if(!allDebts[userPhone]) allDebts[userPhone] = [];

// حفظ
function save(){
    localStorage.setItem("debts", JSON.stringify(allDebts));
}

// إضافة دين جديد
function addDebt(){
    let name = dName.value.trim();
    let type = dType.value;
    let amount = dAmount.value.trim();

    if(name === "" || amount === ""){
        alert("أكمل الحقول");
        return;
    }

    allDebts[userPhone].push({
        name: name,
        type: type,
        amount: Number(amount),
        date: new Date().toLocaleDateString()
    });

    save();
    clearInputs();
    render();
}

function clearInputs(){
    dName.value = "";
    dAmount.value = "";
}

// عرض بحسب البحث
function render(){
    let name = searchName.value.trim();

    let list = allDebts[userPhone].filter(d =>
        d.name.includes(name)
    );

    let html = "";
    let sum = 0;

    list.forEach((d,i)=>{
        sum += Number(d.amount);

        html += `
        <div style="padding:10px;border:1px solid #aaa;border-radius:8px;margin-bottom:10px;background:#fff;">
            <b>الاسم:</b> ${d.name}<br>
            <b>النوع:</b> ${d.type}<br>
            <b>المبلغ المتبقي:</b> ${d.amount}<br>
            <b>التاريخ:</b> ${d.date}<br><br>

            <button onclick="pay(${getIndex(d)})" style="background:red;">تسديد مبلغ</button>
            <button onclick="addMore(${getIndex(d)})" style="background:orange;">إضافة مبلغ</button>
        </div>
        `;
    });

    resultsBox.innerHTML = html;
    total.innerText = sum;
}

// الحصول على اندكس حقيقي
function getIndex(obj){
    return allDebts[userPhone].indexOf(obj);
}

// إضافة مبلغ
function addMore(i){
    let d = allDebts[userPhone][i];
    let more = prompt("المبلغ المضاف:");
    if(more && !isNaN(more)){
        d.amount = Number(d.amount) + Number(more);
        save();
        render();
    }
}

// تسديد جزئي
function pay(i){
    let d = allDebts[userPhone][i];
    let amt = prompt("أدخل مبلغ التسديد:");

    if(amt === null || amt === "" || isNaN(amt)) return;

    amt = Number(amt);

    if(amt <= 0) return;

    if(amt >= d.amount){
        // تم السداد كامل
        allDebts[userPhone].splice(i,1);
    } else {
        // سداد جزئي
        d.amount = d.amount - amt;
    }

    save();
    render();
}

function logout(){
    localStorage.removeItem("loginUser");
    window.location.href="index.html";
}

render();
</script>

</body>
</html>