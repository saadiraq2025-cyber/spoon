<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>دفتر الديون</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

<h2>إضافة دين جديد</h2>

<input id="dName" placeholder="الاسم">
<input id="dItem" placeholder="المادة">   <!-- الحقل الجديد -->
<select id="dType">
    <option value="مدين">مدين</option>
    <option value="مدان">مدان</option>
</select>
<input id="dAmount" type="number" placeholder="المبلغ">

<button onclick="addDebt()">إضافة الدين</button>

<hr style="margin:20px 0;">

<h2>البحث عن مدين / مدان</h2>

<input id="searchName" placeholder="ابحث بالاسم" oninput="render()">

<div id="resultsBox" style="margin-top:20px;"></div>

<div class="totalBox">المجموع الكلي: <span id="total">0</span> دينار</div>

<button onclick="logout()" style="background:red;margin-top:15px;">خروج</button>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
// إعداد فيربيز
const firebaseConfig = {
  apiKey: "AIzaSyA_3TFx5dUR3JbcXj5jFIZ_mpjWeco7FVo",
  authDomain: "tktkbaghdad.firebaseapp.com",
  databaseURL: "https://tktkbaghdad-default-rtdb.firebaseio.com",
  projectId: "tktkbaghdad",
  storageBucket: "tktkbaghdad.firebasestorage.app",
  messagingSenderId: "939931176033",
  appId: "1:939931176033:web:1d44fa5fd01ee75b326e20"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let userPhone = localStorage.getItem("loginPhone");
if(!userPhone) window.location.href = "index.html";

let debtsRef = db.ref("debts/" + userPhone);

// إضافة دين جديد
function addDebt(){
    let name = dName.value.trim();
    let item = dItem.value.trim();  // المادة
    let type = dType.value;
    let amount = dAmount.value.trim();

    if(name === "" || item === "" || amount === ""){
        alert("أكمل الحقول");
        return;
    }

    let debt = {
        name: name,
        item: item,       // تخزين المادة
        type: type,
        amount: Number(amount),
        date: new Date().toLocaleDateString()
    };

    debtsRef.push(debt);

    dName.value = "";
    dItem.value = "";
    dAmount.value = "";
    render();
}

// عرض نتائج البحث
function render(){
    let search = searchName.value.trim();

    debtsRef.once("value", snap => {
        let html = "";
        let sum = 0;

        snap.forEach(child => {
            let d = child.val();
            let key = child.key;

            if(!d.name.includes(search)) return;

            sum += d.amount;

            html += `
            <div style="padding:10px;border:1px solid #aaa;border-radius:8px;margin-bottom:10px;background:#fff;">
                <b>الاسم:</b> ${d.name}<br>
                <b>المادة:</b> ${d.item}<br>
                <b>النوع:</b> ${d.type}<br>
                <b>المبلغ المتبقي:</b> ${d.amount}<br>
                <b>التاريخ:</b> ${d.date}<br><br>

                <button onclick="pay('${key}')" style="background:red;">تسديد مبلغ</button>
                <button onclick="addMore('${key}')" style="background:orange;">إضافة مبلغ</button>
            </div>
            `;
        });

        resultsBox.innerHTML = html;
        total.innerText = sum;
    });
}

// إضافة مبلغ
function addMore(key){
    let more = prompt("المبلغ المضاف:");
    if(!more || isNaN(more)) return;

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();
        let newAmt = d.amount + Number(more);
        debtsRef.child(key).update({amount: newAmt});
        render();
    });
}

// تسديد جزئي
function pay(key){
    let amt = prompt("أدخل مبلغ التسديد:");
    if(!amt || isNaN(amt)) return;

    amt = Number(amt);

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();

        if(amt >= d.amount){
            debtsRef.child(key).remove();
        } else {
            debtsRef.child(key).update({amount: d.amount - amt});
        }

        render();
    });
}

function logout(){
    localStorage.removeItem("loginPhone");
    localStorage.removeItem("loginUser");
    window.location.href = "index.html";
}

render();
</script>

</body>
</html>