<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>دفتر الديون</title>
<link rel="stylesheet" href="style.css">

<style>
/* جعل عرض الحقول 6 سم */
input, select {
    width: 6cm !important;
    max-width: 100%;
    padding: 10px;
    font-size: 17px;
    margin-top: 8px;
    border-radius: 8px;
    border: 2px solid #aaa;
}

/* لون أحمر إذا كان الحقل فارغ */
input:invalid, select:invalid {
    border-color: red;
    background: #ffe5e5;
}

.container {
    max-width: 95%;
    margin: auto;
}

button{
    width: 6cm;
    max-width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    background:#2e7d32;
    color:white;
}
</style>
</head>

<body>

<div class="container">

<h2>إضافة دين جديد</h2>

<input id="dName" placeholder="الاسم" required>
<input id="dItem" placeholder="المادة" required>
<select id="dType" required>
    <option value="مدين">مدين</option>
    <option value="مدان">مدان</option>
</select>
<input id="dAmount" type="number" placeholder="المبلغ" required>
<input id="dNote" placeholder="ملاحظات (اختياري)">

<button onclick="addDebt()">إضافة الدين</button>

<hr style="margin:20px 0;">

<h2>البحث عن مدين / مدان</h2>

<input id="searchName" placeholder="ابحث بالاسم" oninput="render()">

<div id="resultsBox" style="margin-top:20px;"></div>

<div class="totalBox">المجموع الكلي: <span id="total">0</span> دينار</div>

<button onclick="logout()" style="background:red;margin-top:15px;">خروج</button>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
// إعداد فيربيز
const firebaseConfig = {
  apiKey: "AIzaSyA_3TFx5dUR3JbcXj5jFIZ_mpjWeco7FVo",
  authDomain: "tktkbaghdad.firebaseapp.com",
  databaseURL: "https://tktkbaghdad-default-rtdb.firebaseio.com",
  projectId: "tktkbaghdad",
  storageBucket: "tktkbaghdad.firebasestorage.app",
  messagingSenderId: "939931176033",
  appId: "1:939931176033:web:1d44fa5fd01ee75b326e20"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let userPhone = localStorage.getItem("loginPhone");
if(!userPhone) window.location.href = "index.html";

let debtsRef = db.ref("debts/" + userPhone);

// إضافة دين جديد
function addDebt(){
    let name = dName.value.trim();
    let item = dItem.value.trim();
    let type = dType.value;
    let amount = dAmount.value.trim();
    let note = dNote.value.trim();

    if(name === "" || item === "" || amount === ""){
        alert("الرجاء ملء الحقول المطلوبة");
        return;
    }

    let debt = {
        name: name,
        item: item,
        type: type,
        amount: Number(amount),
        note: note,
        date: new Date().toLocaleDateString()
    };

    debtsRef.push(debt);

    dName.value = "";
    dItem.value = "";
    dAmount.value = "";
    dNote.value = "";
    render();
}

// عرض نتائج البحث
function render(){
    let search = searchName.value.trim();

    debtsRef.once("value", snap => {
        let html = "";
        let sum = 0;

        snap.forEach(child => {
            let d = child.val();
            let key = child.key;

            if(!d.name.includes(search)) return;

            sum += d.amount;

            html += `
            <div style="padding:10px;border:1px solid #aaa;border-radius:8px;margin-bottom:10px;background:#fff;">
                <b>الاسم:</b> ${d.name}<br>
                <b>المادة:</b> ${d.item}<br>
                <b>النوع:</b> ${d.type}<br>
                <b>المبلغ المتبقي:</b> ${d.amount}<br>
                <b>التاريخ:</b> ${d.date}<br>
                <b>ملاحظات:</b> ${d.note ? d.note : "لا يوجد"}<br><br>

                <button onclick="pay('${key}')" style="background:red;">تسديد مبلغ</button>
                <button onclick="addMore('${key}')" style="background:orange;">إضافة مبلغ</button>
            </div>
            `;
        });

        resultsBox.innerHTML = html;
        total.innerText = sum;
    });
}

// إضافة مبلغ
function addMore(key){
    let more = prompt("المبلغ المضاف:");
    if(!more || isNaN(more)) return;

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();
        let newAmt = d.amount + Number(more);
        debtsRef.child(key).update({amount: newAmt});
        render();
    });
}

// تسديد جزئي
function pay(key){
    let amt = prompt("أدخل مبلغ التسديد:");
    if(!amt || isNaN(amt)) return;

    amt = Number(amt);

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();

        if(amt >= d.amount){
            debtsRef.child(key).remove();
        } else {
            debtsRef.child(key).update({amount: d.amount - amt});
        }

        render();
    });
}

function logout(){
    localStorage.removeItem("loginPhone");
    localStorage.removeItem("loginUser");
    window.location.href = "index.html";
}

render();
</script>

</body>
</html>