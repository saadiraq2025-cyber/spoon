<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الديون</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">
<h2>دفتر الديون</h2>

<div>
<input id="name" placeholder="اسم المدين">
<input id="amount" type="number" placeholder="المبلغ">
<button onclick="addDebt()">إضافة</button>
</div>

<table>
<thead>
<tr>
<th>المدين</th>
<th>المبلغ</th>
<th>التاريخ</th>
<th>إدارة</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>

<div class="totalBox">المجموع الكلي: <span id="total">0</span> دينار</div>

<button onclick="exportExcel()">تصدير Excel</button>
<button onclick="logout()" style="background:red;margin-top:15px;">خروج</button>

</div>

<script>
let loginUser = JSON.parse(localStorage.getItem("loginUser"));
if(!loginUser) window.location.href="index.html";

let userPhone = loginUser.role==="admin"
    ? localStorage.getItem("editUserPhone")
    : loginUser.phone;

if(!userPhone) userPhone = loginUser.phone;

let allDebts = JSON.parse(localStorage.getItem("debts") || "{}");

if(!allDebts[userPhone]) allDebts[userPhone] = [];

function save(){
    localStorage.setItem("debts", JSON.stringify(allDebts));
}

function render(){
    let debts = allDebts[userPhone];
    list.innerHTML = "";
    let sum = 0;

    debts.forEach((d,i)=>{
        sum += Number(d.amount);
        list.innerHTML += `
        <tr>
            <td>${d.name}</td>
            <td>${d.amount}</td>
            <td>${d.date}</td>
            <td>
                <button onclick="pay(${i})">تسديد</button>
                <button onclick="edit(${i})" style="background:orange;">تعديل</button>
            </td>
        </tr>
        `;
    });

    total.innerText = sum;
}

function addDebt(){
    if(name.value=="" || amount.value=="") return;

    allDebts[userPhone].push({
        name:name.value,
        amount:amount.value,
        date:new Date().toLocaleDateString()
    });

    save();
    render();

    name.value="";
    amount.value="";
}

function pay(i){
    allDebts[userPhone].splice(i,1);
    save();
    render();
}

function edit(i){
    let d = allDebts[userPhone][i];
    let newAmount = prompt("المبلغ الجديد:", d.amount);
    if(newAmount){
        d.amount = newAmount;
        save();
        render();
    }
}

function exportExcel(){
    let data = "المدين,المبلغ,التاريخ\n";
    allDebts[userPhone].forEach(d=>{
        data += `${d.name},${d.amount},${d.date}\n`;
    });

    let blob = new Blob([data], {type:"text/csv"});
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "debts.csv";
    a.click();
}

function logout(){
    localStorage.removeItem("loginUser");
    window.location.href="index.html";
}

render();
</script>

</body>
</html>
