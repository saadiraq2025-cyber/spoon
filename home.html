<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>دفتر الديون</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">
<h2>البحث عن مدين / مدان</h2>

<input id="searchName" placeholder="ابحث باسم الشخص" oninput="render()">

<div id="resultsBox" style="margin-top:20px;"></div>

<div class="totalBox">المجموع الكلي: <span id="total">0</span> دينار</div>

<button onclick="logout()" style="background:red;margin-top:15px;">خروج</button>

</div>

<script>
let loginUser = JSON.parse(localStorage.getItem("loginUser"));
if(!loginUser) window.location.href="index.html";

// رقم المستخدم
let userPhone = loginUser.phone;

// جلب جميع الديون
let allDebts = JSON.parse(localStorage.getItem("debts") || "{}");

// إنشاء قائمة فارغة لو المستخدم جديد
if(!allDebts[userPhone]) allDebts[userPhone] = [];

// حفظ البيانات
function save(){
    localStorage.setItem("debts", JSON.stringify(allDebts));
}

// عرض النتائج
function render(){
    let name = searchName.value.trim();

    let list = allDebts[userPhone].filter(d => 
        d.name.includes(name)
    );

    let html = "";
    let sum = 0;

    list.forEach((d,i)=>{
        sum += Number(d.amount);

        html += `
        <div style="padding:10px;border:1px solid #aaa;border-radius:8px;margin-bottom:10px;background:#fff;">
            <b>الاسم:</b> ${d.name}<br>
            <b>النوع:</b> ${d.type}<br>
            <b>المبلغ:</b> ${d.amount}<br>
            <b>التاريخ:</b> ${d.date}<br><br>

            <button onclick="pay(${getIndex(d)})" style="background:red;">تسديد</button>
            <button onclick="addMore(${getIndex(d)})" style="background:orange;">إضافة مبلغ</button>
        </div>
        `;
    });

    resultsBox.innerHTML = html;
    total.innerText = sum;
}

// الحصول على رقم العنصر الصحيح
function getIndex(obj){
    return allDebts[userPhone].indexOf(obj);
}

// إضافة مبلغ
function addMore(i){
    let d = allDebts[userPhone][i];
    let more = prompt("المبلغ المضاف:");

    if(more){
        d.amount = Number(d.amount) + Number(more);
        save();
        render();
    }
}

// تسديد مبلغ (مسح الدين)
function pay(i){
    allDebts[userPhone].splice(i,1);
    save();
    render();
}

function logout(){
    localStorage.removeItem("loginUser");
    window.location.href="index.html";
}

// تشغيل أولي
render();
</script>

</body>
</html>