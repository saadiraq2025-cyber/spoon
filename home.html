<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>Ø¯ÙØªØ± Ø§Ù„Ø¯ÙŠÙˆÙ†</title>
<link rel="stylesheet" href="style.css">

<style>
/* Ø¬Ø¹Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ 6 Ø³Ù… */
input {
    width: 6cm !important;
    max-width: 100%;
    padding: 10px;
    font-size: 17px;
    margin-top: 8px;
    border-radius: 8px;
    border: 2px solid #aaa;
}

/* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº */
input:invalid {
    border-color: red;
    background: #ffe5e5;
}

.container {
    max-width: 95%;
    margin: auto;
}

button{
    width: 6cm;
    max-width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    background:#2e7d32;
    color:white;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
#reportBox{
    display:none;
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    background:rgba(0,0,0,0.6);
    justify-content:center;
    align-items:center;
    z-index:999;
}
#reportContent{
    background:white;
    width:95%;
    max-width:700px;
    padding:20px;
    border-radius:10px;
    max-height:90vh;
    overflow:auto;
}
#printBtn{
    background:#0077cc;
}
#closeReport{
    background:red;
}
</style>
</head>

<body>

<div class="container">

<h2>Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯</h2>

<input id="dName" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
<input id="dItem" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" required>
<input id="dQty" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" required>
<input id="dAmount" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" required>
<input id="dNote" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">

<button onclick="addDebt()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙŠÙ†</button>

<hr style="margin:20px 0;">

<h2>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯ÙŠÙ†</h2>

<input id="searchName" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…" oninput="render()">

<button style="background:#0077cc" onclick="openReport()">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>

<div id="resultsBox" style="margin-top:20px;"></div>

<div class="totalBox">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: <span id="total">0</span> Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</div>

<button onclick="logout()" style="background:red;margin-top:15px;">Ø®Ø±ÙˆØ¬</button>

</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
<div id="reportBox">
    <div id="reportContent">
        <h3 style="text-align:center;">ğŸ“„ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
        <div id="reportData"></div>

        <button id="printBtn" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <button id="closeReport" onclick="closeReport()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
// Ø¥Ø¹Ø¯Ø§Ø¯ ÙÙŠØ±Ø¨ÙŠØ²
const firebaseConfig = {
  apiKey: "AIzaSyA_3TFx5dUR3JbcXj5jFIZ_mpjWeco7FVo",
  authDomain: "tktkbaghdad.firebaseapp.com",
  databaseURL: "https://tktkbaghdad-default-rtdb.firebaseio.com",
  projectId: "tktkbaghdad",
  storageBucket: "tktkbaghdad.firebasestorage.app",
  messagingSenderId: "939931176033",
  appId: "1:939931176033:web:1d44fa5fd01ee75b326e20"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>
let userPhone = localStorage.getItem("loginPhone");
if(!userPhone) window.location.href = "index.html";

let debtsRef = db.ref("debts/" + userPhone);

// Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯
function addDebt(){
    let name = dName.value.trim();
    let item = dItem.value.trim();
    let qty  = dQty.value.trim();
    let amount = dAmount.value.trim();
    let note = dNote.value.trim();

    if(name === "" || item === "" || amount === "" || qty === ""){
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
    }

    let total = Number(qty) * Number(amount);

    let debt = {
        name: name,
        item: item,
        qty: Number(qty),
        unit: Number(amount),
        amount: total,
        note: note,
        date: new Date().toLocaleDateString()
    };

    debtsRef.push(debt);

    dName.value = "";
    dItem.value = "";
    dQty.value = "";
    dAmount.value = "";
    dNote.value = "";
    render();
}

// Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
function render(){
    let search = searchName.value.trim();

    debtsRef.once("value", snap => {
        let list = [];
        let sum = 0;

        snap.forEach(child => {
            let d = child.val();
            d.key = child.key;
            if(d.name.includes(search)) list.push(d);
        });

        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº
        list.sort((a,b)=> b.amount - a.amount);

        let html = "";

        list.forEach(d=>{
            sum += d.amount;

            html += `
            <div style="padding:10px;border:1px solid #aaa;border-radius:8px;margin-bottom:10px;background:#fff;">
                <b>Ø§Ù„Ø§Ø³Ù…:</b> ${d.name}<br>
                <b>Ø§Ù„Ù…Ø§Ø¯Ø©:</b> ${d.item}<br>
                <b>Ø§Ù„Ø¹Ø¯Ø¯:</b> ${d.qty}<br>
                <b>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</b> ${d.unit} Ø¯ÙŠÙ†Ø§Ø±<br>
                <b>Ø§Ù„Ù…Ø¨Ù„Øº:</b> ${d.amount} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ<br>
                <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${d.date}<br>
                <b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${d.note ? d.note : "Ù„Ø§ ÙŠÙˆØ¬Ø¯"}<br><br>

                <button onclick="pay('${d.key}')" style="background:red;">ØªØ³Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº</button>
                <button onclick="addMore('${d.key}')" style="background:orange;">Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button>
            </div>
            `;
        });

        resultsBox.innerHTML = html;
        total.innerText = sum;
    });
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº
function addMore(key){
    let more = prompt("Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¶Ø§Ù (Ø¯ÙŠÙ†Ø§Ø±):");
    if(!more || isNaN(more)) return;

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();
        let newAmt = d.amount + Number(more);
        debtsRef.child(key).update({amount: newAmt});
        render();
    });
}

// ØªØ³Ø¯ÙŠØ¯ Ø¬Ø²Ø¦ÙŠ
function pay(key){
    let amt = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ³Ø¯ÙŠØ¯ (Ø¯ÙŠÙ†Ø§Ø±):");
    if(!amt || isNaN(amt)) return;

    amt = Number(amt);

    debtsRef.child(key).once("value", snap => {
        let d = snap.val();

        if(amt >= d.amount){
            debtsRef.child(key).remove();
        } else {
            debtsRef.child(key).update({amount: d.amount - amt});
        }

        render();
    });
}

// ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
function openReport(){
    debtsRef.once("value", snap => {

        let list = [];
        let total = 0;

        snap.forEach(ch=>{
            let d = ch.val();
            list.push(d);
        });

        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø£Ø¹Ù„Ù‰ Ù…Ø¨Ù„Øº
        list.sort((a,b)=> b.amount - a.amount);

        let html = `
        <table border="1" style="width:100%; border-collapse:collapse;">
        <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th>Ø§Ù„Ø¹Ø¯Ø¯</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th>
            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>`;

        list.forEach(d=>{
            total += d.amount;

            html += `
            <tr>
                <td>${d.name}</td>
                <td>${d.item}</td>
                <td>${d.qty}</td>
                <td>${d.unit} Ø¯ÙŠÙ†Ø§Ø±</td>
                <td>${d.amount} Ø¯ÙŠÙ†Ø§Ø±</td>
                <td>${d.date}</td>
                <td>${d.note||"Ù„Ø§ ÙŠÙˆØ¬Ø¯"}</td>
            </tr>`;
        });

        html += `</table>
        <h3 style="margin-top:15px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${total} Ø¯ÙŠÙ†Ø§Ø± Ø¹Ø±Ø§Ù‚ÙŠ</h3>`;

        reportData.innerHTML = html;
        reportBox.style.display = "flex";
    });
}

function closeReport(){
    reportBox.style.display = "none";
}

function logout(){
    localStorage.removeItem("loginPhone");
    localStorage.removeItem("loginUser");
    window.location.href = "index.html";
}

render();
</script>

</body>
</html>