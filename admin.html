<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المدير</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="container">

<h2>لوحة التحكم</h2>

<h3>إضافة مستخدم جديد</h3>

<input id="nPhone" placeholder="رقم الهاتف" class="in">
<input id="nPass" placeholder="كلمة المرور" class="in">

<button onclick="addUser()" class="btn-green">إضافة المستخدم</button>

<h3>جميع المستخدمين</h3>

<table>
<thead>
<tr>
<th>الهاتف</th>
<th>الحالة</th>
<th>انتهاء الاشتراك</th>
<th>إدارة</th>
</tr>
</thead>
<tbody id="uList"></tbody>
</table>

<button onclick="logout()" class="btn-red" style="margin-top:20px;">تسجيل خروج</button>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyA_3TFx5dUR3JbcXj5jFIZ_mpjWeco7FVo",
  authDomain: "tktkbaghdad.firebaseapp.com",
  databaseURL: "https://tktkbaghdad-default-rtdb.firebaseio.com",
  projectId: "tktkbaghdad",
  storageBucket: "tktkbaghdad.firebasestorage.app",
  messagingSenderId: "939931176033",
  appId: "1:939931176033:web:1d44fa5fd01ee75b326e20"
});

const db = firebase.database();
let usersRef = db.ref("users");

function addUser(){
    let p = nPhone.value.trim();
    let pw = nPass.value.trim();
    if(p=="" || pw==""){ alert("أكمل الحقول"); return; }

    usersRef.child(p).set({
        phone:p,
        pass:pw,
        role:"user",
        ban:false,
        expire:0
    });

    nPhone.value="";
    nPass.value="";
    loadUsers();
}

function loadUsers(){
    usersRef.once("value", snap=>{
        uList.innerHTML="";

        snap.forEach(ch=>{
            let u = ch.val();
            let ph = u.phone;
            let exp = u.expire == 0 ? "دائم" : new Date(u.expire).toLocaleString();

            uList.innerHTML += `
            <tr>
                <td>${ph}</td>
                <td>${u.ban?"محظور":"نشط"}</td>
                <td>${exp}</td>
                <td>
                    <button onclick="openDebts('${ph}')">فتح</button>
                    <button onclick="editUser('${ph}')" class="btn-blue">تعديل</button>
                    <button onclick="toggleBan('${ph}',${u.ban})" style="background:orange;">
                        ${u.ban?"إلغاء الحظر":"حظر"}
                    </button>
                    <button onclick="activate('${ph}')" style="background:#444;">تفعيل</button>
                    <button onclick="deleteUser('${ph}')" style="background:red;">حذف</button>
                </td>
            </tr>`;
        });
    });
}

// تعديل المستخدم بالكامل (رقم + كلمة مرور)
function editUser(oldPhone){
    let newPhone = prompt("رقم الهاتف الجديد:", oldPhone);
    if(!newPhone) return;

    db.ref("users/"+oldPhone).once("value", s=>{
        let u = s.val();

        let newPass = prompt("كلمة المرور الجديدة:", u.pass);
        if(!newPass) return;

        // إضافة مستخدم جديد
        db.ref("users/"+newPhone).set({
            phone:newPhone,
            pass:newPass,
            role:u.role,
            ban:u.ban,
            expire:u.expire
        });

        // نقل الديون
        db.ref("debts/"+oldPhone).once("value", dSnap=>{
            db.ref("debts/"+newPhone).set(dSnap.val());
            db.ref("debts/"+oldPhone).remove();
        });

        // حذف القديم
        db.ref("users/"+oldPhone).remove();

        loadUsers();
    });
}

function toggleBan(phone, s){
    usersRef.child(phone).update({ban:!s});
    loadUsers();
}

function activate(phone){
    let days = prompt("عدد الأيام:");
    if(!days || isNaN(days)) return;

    let ms = days * 24 * 60 * 60 * 1000;
    usersRef.child(phone).update({expire:Date.now()+ms});

    loadUsers();
}

function deleteUser(phone){
    if(confirm("حذف المستخدم نهائياً؟")){
        db.ref("users/"+phone).remove();
        db.ref("debts/"+phone).remove();
        loadUsers();
    }
}

function openDebts(phone){
    localStorage.setItem("loginPhone", phone);
    window.location="home.html";
}

function logout(){
    localStorage.removeItem("loginUser");
    window.location="index.html";
}

loadUsers();
</script>

<style>
.btn-blue{background:#0077cc;color:white;padding:6px 10px;border:none;border-radius:6px;}
.in{width:100%;padding:12px;margin-top:8px;border-radius:6px;border:1px solid #aaa;}
.btn-green{width:100%;padding:12px;margin-top:10px;border:none;border-radius:6px;background:#2e7d32;color:white;}
.btn-dark{width:100%;padding:12px;margin-top:10px;border:none;border-radius:6px;background:#333;color:white;}
.btn-red{width:100%;padding:12px;border:none;border-radius:6px;background:red;color:white;}
table{width:100%;margin-top:15px;border-collapse:collapse;}
td,th{border:1px solid #ccc;padding:8px;text-align:center;}
</style>

</body>
</html>